<?xml version="1.0" encoding="UTF-8"?>

<!-- ====================================================================== -->
<!-- Ant build file (http://ant.apache.org/) for Ant 1.8.2 or above.        -->
<!-- ====================================================================== -->

<project name="swat-dp-backup"
         default="info"
         basedir=".">

	<description>DataPower backup/restore project (Swat4DPops) based on IBM's WAMT.</description>

	<property environment="env" />

	<!-- ====================================================================== -->
	<!-- Import property files                                                  -->
	<!-- ====================================================================== -->

	<!-- Get global properties from build.properties -->
	<property file="build.properties" />


	<!-- ====================================================================== -->
	<!-- Help target                                                            -->
	<!-- ====================================================================== -->

	<target name="help">
		<echo message="Swat4DP - Backup/Restore Module %VERSION%" />
		<echo message="Please run: $ant -projecthelp" />
	</target>

	<target name="declare">

		<!-- define the classpath for the additional tasks -->
		<path id="dp.tools.classpath">
			<pathelement location="${basedir}"/>
			<fileset dir="${basedir}/lib" includes="*.jar" />
		</path>

		<!-- Task Definitions -->
		<!-- declare antcontrib tasks -->
		<taskdef resource="net/sf/antcontrib/antlib.xml"
		         classpathref="dp.tools.classpath" />

		<!-- declare additional tasks from the this project -->
		<taskdef name="securebackup"
		         classname="ch.srsx.swat.datapower.tools.ant.taskdefs.SecureBackup"
		         classpathref="dp.tools.classpath" />
		<taskdef name="securerestore"
		         classname="ch.srsx.swat.datapower.tools.ant.taskdefs.SecureRestore"
		         classpathref="dp.tools.classpath" />

		<!-- antform tasks -->
		<taskdef resource="com/sardak/antform/taskdefs.properties"
		         classpathref="dp.tools.classpath" />

	</target>

	<!-- ============== -->
	<!-- Initialization -->
	<!-- ============== -->
	<target name="init" depends="declare">
		<!-- Create the time stamp -->
		<tstamp>
			<format property="FILESTAMP" pattern="yyyyMMdd_HHmmss" />
		</tstamp>

		<!-- Get global environment properties -->

		<!-- Get user specific properties from <user.properties.file> -->
		<if>
			<isset property="user.properties.file" />
			<then>
				<property file="${user.properties.file}" />
			</then>
			<else>
				<property file="${user.name}.properties" />
			</else>
		</if>

	</target>

	<!-- ================================= 
          target: info              
         ================================= -->
	<target name="info" depends="init" description="show project information">
		<!-- Displays the properties for this run -->
		<echo message="OS=${os.name}" />
		<echo message="JDK=${ant.java.version}" />
		<echo message="${ant.version}" />
		<echo message="build file=${ant.file}" />
		<echo message="project=${ant.project.name}" />
		<echo message="" />

		<echo message="********************************************" />
		<echoproperties prefix="project" />
		<echoproperties prefix="ant" />
		<echoproperties prefix="java" />

		<echo message="--------------------------------------------" />
		<echoproperties prefix="env" />
		<echo message="--------------------------------------------" />
		<echoproperties prefix="dp" />

		<echo message="********************************************" />
		<echo message="USAGE: # ant -projecthelp" />
	</target>


	<!-- ================================= 
          target: securebackup              
         ================================= -->
	<target name="securebackup"
	        depends="init, selectDevice"
	        description="--> creates a secure backup and stores the files on the backup server">

		<antform title="Swat4DP - Backup/Restore Module">
			<label>Secure Backup</label>
			<textProperty label="Hostname :"
			                   property="dp.hostname" />
			<textProperty label="Port : "
			              property="dp.port" />
			<textProperty label="Password : "
			              property="dp.password"
			              password="true" />
			<fileSelectionProperty label="Seclect target directory : "
			                       property="securebackup.targetdir"
			                       directoryChooser="true"
			                       tooltip="Name of the directory where the backup files should be stored." />
			<booleanProperty label="include RAID ?"
			                 property="securebackup.includeraid"
			                 tooltip="Whether to include the content of the harddisk array." />
			<booleanProperty label="force overwrite ?"
			                 property="securebackup.forceoverwrite"
			                 tooltip="Overwrite existing files in the target directory." />
			<controlbar>
				<button label="Cancel" type="cancel" />
				<button label="Ok" type="ok" />
			</controlbar>
		</antform>

		<fail unless="securebackup.targetdir"
		      message="Secure Backup has been aborted." />

		<securebackup targetBaseDir="${securebackup.targetdir}"
		              hostname="${dp.hostname}"
					  port="${dp.port}"
		              password="${dp.password}"
		              includeRAID="${securebackup.includeraid}"
		              forceOverwrite="${securebackup.forceoverwrite}" />
	</target>


	<!-- ================================= 
          target: securerestore              
         ================================= -->
	<target name="securerestore"
	        depends="init,selectDevice"
	        description="--> restore a device using a secure backup">

		<property name="securerestore.port" value="${dp.mgmt.port}" />
		<antform title="Swat4DP - Backup/Restore Module">
			<label>Secure Restore</label>
			<textProperty label="Hostname :"
			                   property="dp.hostname" />
			<textProperty label="Port : "
			              property="dp.port" />
			<textProperty label="Password : "
			              property="dp.password"
			              password="true" />
			<fileSelectionProperty label="Seclect source directory : "
			                       property="securerestore.sourcedir"
			                       directoryChooser="true"
			                       tooltip="Name of the directory where the backup files are stored." />
			<booleanProperty label="validate?"
			                 property="securerestore.validate"
			                 tooltip="If set to true, the backup files will be validated but no restore is performed." />
			<controlbar>
				<button label="Cancel" type="cancel" />
				<button label="Ok" type="ok" />
			</controlbar>
		</antform>
		
		<fail unless="securerestore.sourcedir"
		      message="Secure Restore has been aborted." />

		<securerestore sourceBaseDir="${securerestore.sourcedir}"
		               hostname="${dp.hostname}"
			           port="${dp.port}"
		               password="${dp.password}"
		               validate="${securerestore.validate}" />
	</target>
	
	<!-- - - - - - - - - - - - - - - - - - 
          target: selectDevice                      
         - - - - - - - - - - - - - - - - - -->
    <target name="selectDevice">
		<antform title="Swat4DP - Backup/Restore Module">
			<label>Select Device</label>
			<selectionproperty label="DataPower device :"
			                   property="device.name"
			                   values="${dp.device.list}" />
			<controlbar>
				<button label="Cancel" type="cancel" />
				<button label="Ok" type="ok" />
			</controlbar>
		</antform>

		<fail unless="device.name"
		      message="Device selection has been aborted." />
    	
    	<loadproperties srcfile="${basedir}/devices/${device.name}.properties"  />
    </target>



</project>
